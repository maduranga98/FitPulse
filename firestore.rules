rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // IMPORTANT NOTE
    // ============================================
    // This application currently uses custom authentication (localStorage)
    // rather than Firebase Authentication. These rules provide data validation
    // and write protection while allowing reads for the application to function.
    //
    // For full security, implement Firebase Authentication and update rules
    // to check request.auth for all operations.
    // ============================================

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Validate required fields are present
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    // Validate phone format (10+ digits)
    function isValidPhone(phone) {
      return phone.matches('^[0-9]{10,15}$');
    }

    // Check if data fields are not being modified
    function unchangedFields(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    // Validate gymId consistency (resource must have same gymId as data)
    function isSameGym() {
      return !('gymId' in request.resource.data) ||
             !('gymId' in resource.data) ||
             request.resource.data.gymId == resource.data.gymId;
    }

    // Validate positive numbers
    function isPositive(value) {
      return value is number && value > 0;
    }

    // ============================================
    // GYMS COLLECTION
    // ============================================
    match /gyms/{gymId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'address', 'phone', 'email', 'status']) &&
                      isValidEmail(request.resource.data.email) &&
                      isValidPhone(request.resource.data.phone) &&
                      request.resource.data.status in ['active', 'inactive'];

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'address', 'phone', 'email', 'status']) &&
                      isValidEmail(request.resource.data.email) &&
                      isValidPhone(request.resource.data.phone) &&
                      request.resource.data.status in ['active', 'inactive'];

      // Allow deletes (application will control this)
      allow delete: if true;
    }

    // ============================================
    // USERS COLLECTION (Gym Admins & Managers)
    // ============================================
    match /users/{userId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['username', 'password', 'name', 'email', 'role', 'gymId']) &&
                      isValidEmail(request.resource.data.email) &&
                      request.resource.data.role in ['super_admin', 'gym_admin', 'gym_manager'];

      // Allow updates with validation (protect critical fields)
      allow update: if hasRequiredFields(['username', 'name', 'email', 'role', 'gymId']) &&
                      isValidEmail(request.resource.data.email) &&
                      unchangedFields(['gymId']) &&
                      request.resource.data.role in ['super_admin', 'gym_admin', 'gym_manager'];

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // MEMBERS COLLECTION
    // ============================================
    match /members/{memberId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'email', 'phone', 'gymId']) &&
                      isValidEmail(request.resource.data.email) &&
                      isValidPhone(request.resource.data.phone) &&
                      (!('membershipType' in request.resource.data) ||
                       request.resource.data.membershipType in ['basic', 'premium', 'platinum']) &&
                      (!('status' in request.resource.data) ||
                       request.resource.data.status in ['active', 'inactive', 'suspended']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'email', 'phone', 'gymId']) &&
                      isValidEmail(request.resource.data.email) &&
                      isValidPhone(request.resource.data.phone) &&
                      isSameGym() &&
                      (!('membershipType' in request.resource.data) ||
                       request.resource.data.membershipType in ['basic', 'premium', 'platinum']) &&
                      (!('status' in request.resource.data) ||
                       request.resource.data.status in ['active', 'inactive', 'suspended']);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // EXERCISES COLLECTION (Gym-specific)
    // ============================================
    match /exercises/{exerciseId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'category', 'gymId']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'category', 'gymId']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // COMMON EXERCISES COLLECTION (Global Library)
    // ============================================
    match /commonExercises/{exerciseId} {
      // Allow reads for all
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'category']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'category']);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // EXERCISE PROGRAMS COLLECTION
    // ============================================
    match /exercisePrograms/{programId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'gymId']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'gymId']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // SCHEDULES COLLECTION
    // ============================================
    match /schedules/{scheduleId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['memberId', 'gymId', 'date']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['memberId', 'gymId', 'date']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // CLASSES COLLECTION
    // ============================================
    match /classes/{classId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'gymId', 'date', 'time']) &&
                      (!('capacity' in request.resource.data) ||
                       isPositive(request.resource.data.capacity));

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'gymId', 'date', 'time']) &&
                      isSameGym() &&
                      (!('capacity' in request.resource.data) ||
                       isPositive(request.resource.data.capacity));

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // EQUIPMENT COLLECTION
    // ============================================
    match /equipment/{equipmentId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'gymId']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'gymId']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // PAYMENTS COLLECTION
    // ============================================
    match /payments/{paymentId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['memberId', 'amount', 'gymId', 'date']) &&
                      isPositive(request.resource.data.amount) &&
                      (!('status' in request.resource.data) ||
                       request.resource.data.status in ['pending', 'completed', 'failed', 'refunded']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['memberId', 'amount', 'gymId', 'date']) &&
                      isSameGym() &&
                      isPositive(request.resource.data.amount) &&
                      (!('status' in request.resource.data) ||
                       request.resource.data.status in ['pending', 'completed', 'failed', 'refunded']);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // COMPLAINTS COLLECTION
    // ============================================
    match /complaints/{complaintId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['subject', 'description', 'memberId', 'gymId']) &&
                      (!('status' in request.resource.data) ||
                       request.resource.data.status in ['open', 'in_progress', 'resolved', 'closed']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['subject', 'description', 'memberId', 'gymId']) &&
                      isSameGym() &&
                      (!('status' in request.resource.data) ||
                       request.resource.data.status in ['open', 'in_progress', 'resolved', 'closed']);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    match /attendance/{attendanceId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates (including from Cloud Functions)
      allow create: if true;

      // Allow updates with validation
      allow update: if 'gymId' in resource.data && isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // SUPPLEMENTS COLLECTION
    // ============================================
    match /supplements/{supplementId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['name', 'gymId']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['name', 'gymId']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // MEAL PLANS COLLECTION
    // ============================================
    match /mealPlans/{mealPlanId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['memberId', 'gymId']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['memberId', 'gymId']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // BODY MEASUREMENTS COLLECTION
    // ============================================
    match /bodyMeasurements/{measurementId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['memberId', 'gymId', 'date']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['memberId', 'gymId', 'date']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // PROGRESS PHOTOS COLLECTION
    // ============================================
    match /progressPhotos/{photoId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['memberId', 'gymId']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['memberId', 'gymId']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // WORKOUT LOGS COLLECTION
    // ============================================
    match /workoutLogs/{logId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates with validation
      allow create: if hasRequiredFields(['memberId', 'gymId', 'date']);

      // Allow updates with validation
      allow update: if hasRequiredFields(['memberId', 'gymId', 'date']) &&
                      isSameGym();

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Allow reads for the application
      allow read: if true;

      // Allow creates
      allow create: if true;

      // Allow updates
      allow update: if true;

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // DEFAULT: ALLOW OTHER COLLECTIONS
    // ============================================
    // Allow access to other collections for flexibility
    match /{document=**} {
      allow read: if true;
      allow write: if true;
    }
  }
}
