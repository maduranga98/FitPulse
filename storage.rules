rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================
    // IMPORTANT NOTE
    // ============================================
    // This application currently uses custom authentication (localStorage)
    // rather than Firebase Authentication. These rules provide file validation
    // while allowing access for the application to function.
    //
    // For full security, implement Firebase Authentication and update rules
    // to check request.auth for all operations.
    // ============================================

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Validate image file type
    function isValidImage() {
      return request.resource.contentType.matches('image/(jpeg|jpg|png|gif|webp)');
    }

    // Validate video file type
    function isValidVideo() {
      return request.resource.contentType.matches('video/(mp4|webm|quicktime|x-msvideo|x-matroska)');
    }

    // Validate image or video file type
    function isValidMedia() {
      return isValidImage() || isValidVideo();
    }

    // Check file size (in bytes)
    function isWithinSizeLimit(maxSize) {
      return request.resource.size <= maxSize;
    }

    // ============================================
    // EXERCISE MEDIA (Images & Videos)
    // ============================================
    // Path: exercises/{gymId}/{exerciseId}/{fileName}
    match /exercises/{gymId}/{exerciseId}/{fileName} {
      // Allow uploads with validation
      // Max size: 50MB for videos, 5MB for images
      allow create: if isValidMedia() &&
                      ((isValidImage() && isWithinSizeLimit(5 * 1024 * 1024)) ||
                       (isValidVideo() && isWithinSizeLimit(50 * 1024 * 1024)));

      // Allow reads for the application
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidMedia() &&
                      ((isValidImage() && isWithinSizeLimit(5 * 1024 * 1024)) ||
                       (isValidVideo() && isWithinSizeLimit(50 * 1024 * 1024)));

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // MEMBER PROGRESS PHOTOS
    // ============================================
    // Path: progress/{gymId}/{memberId}/{fileName}
    match /progress/{gymId}/{memberId}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // FACE REGISTRATION PHOTOS
    // ============================================
    // Path: faces/{gymId}/{memberId}/{fileName}
    match /faces/{gymId}/{memberId}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // ATTENDANCE CHECK-IN PHOTOS
    // ============================================
    // Path: attendance/{gymId}/{date}/{fileName}
    match /attendance/{gymId}/{date}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // TEMP CAPTURES (Face Recognition)
    // ============================================
    // Path: temp-captures/{fileName}
    match /temp-captures/{fileName} {
      // Allow uploads with validation (for Cloud Functions processing)
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow deletes (Cloud Functions cleanup)
      allow delete: if true;
    }

    // ============================================
    // GYM PROFILE IMAGES
    // ============================================
    // Path: gyms/{gymId}/{fileName}
    match /gyms/{gymId}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // MEMBER PROFILE IMAGES
    // ============================================
    // Path: members/{gymId}/{memberId}/{fileName}
    match /members/{gymId}/{memberId}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // EQUIPMENT IMAGES
    // ============================================
    // Path: equipment/{gymId}/{equipmentId}/{fileName}
    match /equipment/{gymId}/{equipmentId}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // SUPPLEMENT IMAGES
    // ============================================
    // Path: supplements/{gymId}/{supplementId}/{fileName}
    match /supplements/{gymId}/{supplementId}/{fileName} {
      // Allow uploads with validation
      // Max size: 5MB
      allow create: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow reads
      allow read: if true;

      // Allow updates with validation
      allow update: if isValidImage() &&
                      isWithinSizeLimit(5 * 1024 * 1024);

      // Allow deletes
      allow delete: if true;
    }

    // ============================================
    // DEFAULT: ALLOW OTHER PATHS
    // ============================================
    // Allow access to other paths for flexibility
    match /{allPaths=**} {
      allow read: if true;
      allow write: if true;
    }
  }
}
